# =====================================================
# 1️⃣ Sample App Deployment (whoami)
# =====================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whoami
  namespace: demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: whoami
  template:
    metadata:
      labels:
        app: whoami
    spec:
      containers:
      - name: whoami
        image: traefik/whoami
        ports:
        - containerPort: 80
---
# =====================================================
# 2️⃣ Service for whoami
# =====================================================
apiVersion: v1
kind: Service
metadata:
  name: whoami
  namespace: demo
spec:
  selector:
    app: whoami
  ports:
  - port: 80
    targetPort: 80
---
# =====================================================
# 3️⃣ Traefik Gateway (HTTP + HTTPS)
# =====================================================
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: traefik-gateway
  namespace: demo
spec:
  gatewayClassName: traefik
  listeners:

  # HTTP Listener (ACME + Redirect handled by routes)
  - name: http
    protocol: HTTP
    port: 80
    allowedRoutes:
      namespaces:
        from: All
  # HTTPS Listener (TLS from cert-manager secret)
  - name: https
    protocol: HTTPS
    port: 443
    tls:
      mode: Terminate
      certificateRefs:
      - kind: Secret
        name: app.anaeleboo.com-secret
        namespace: demo
    allowedRoutes:
      namespaces:
        from: All
---

# =====================================================
# 5️⃣ HTTP → HTTPS Redirect (EXCEPT ACME)
# =====================================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: whoami-redirect
  namespace: demo
spec:
  parentRefs:
  - name: traefik-gateway
    namespace: demo
    sectionName: http

  hostnames:
  - "app.anaeleboo.com"

  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/"

    filters:
    - type: RequestRedirect
      requestRedirect:
        scheme: https
        statusCode: 301
---
# =====================================================
# 6️⃣ HTTPS Route → whoami backend
# =====================================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: whoami-https
  namespace: demo
spec:
  parentRefs:
  - name: traefik-gateway
    namespace: demo
    sectionName: https

  hostnames:
  - "app.anaeleboo.com"

  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/"

    backendRefs:
    - name: whoami
      port: 80
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: app-anaeleboo-cert
  namespace: demo
spec:
  secretName: app.anaeleboo.com-secret
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - app.anaeleboo.com
